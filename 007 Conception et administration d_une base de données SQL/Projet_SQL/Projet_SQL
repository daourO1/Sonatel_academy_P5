sudo mysql

--  EXPORTER ET RESTAURER UN BD
-- Faites un import de la BD “odc_recette_cours.sql”
CREATE DATABASE odc_recette_cours;

use odc_recette_cours;

source /home/daour/Sonatel_academy_P5/007 Conception et administration d_une base de données SQL/Projet_SQL/odc_recette_cours.sql;

SHOW TABLES;

DESCRIBE amende;
DESCRIBE contribuable;
DESCRIBE declaration;
DESCRIBE migration_versions;
DESCRIBE payer_amende;
DESCRIBE payer_taxe;
DESCRIBE quittance;
DESCRIBE taxes;

--  LANGAGE D'INTERROGATION DE DONNEES (LID) : SELECT ;
-- o Projection
-- o Restriction
-- o Jointure
-- o Alias (AS)
-- Donner le nom et l’adresse des contribuables qui ont fait des déclarations
-- publicitaires
-- SELECT DISTINCT contribuable.nom, contribuable.adr 
--  on pouver aussi utiliser le DISTINCT pour supprimer les doublons
SELECT contribuable.nom, contribuable.adr
FROM contribuable
INNER JOIN declaration ON contribuable.ncont = declaration.ncont
WHERE declaration.libelle = 'publicité';


-- o Sous requête
-- Donner le numéro et le nom du premier contribuable qui a payé une amende
-- SELECT contribuable.ncont, contribuable.nom
-- FROM contribuable
-- INNER join payer_amende ON contribuable.ncont = payer_amende.ncont
-- LIMIT 1;
SELECT ncont, nom
FROM contribuable
WHERE ncont = (SELECT ncont FROM payer_amende ORDER BY date ASC LIMIT 1);


-- o Fonctions d'agrégation
-- - SUM
-- Donner le numéro, le nom, le libellé et le montant totale de l’amande payé pour
-- chaque contribuable selon le type(libellé) d’amande
SELECT contribuable.ncont, contribuable.nom, amende.libelle, SUM(amende.montant)
FROM contribuable
INNER JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
INNER JOIN amende ON payer_amende.namende = amende.namende
GROUP BY contribuable.ncont, contribuable.nom, amende.libelle


-- -AVG
-- Donner le numéro, le nom et le montant moyen des taxes payées par chaque
-- contribuable
SELECT contribuable.ncont, nom, AVG(taxes.montant)
FROM contribuable
INNER JOIN payer_taxe ON contribuable.ncont = payer_taxe.ncont
INNER JOIN taxes ON payer_taxe.ntaxe = taxes.ntaxe
GROUP BY contribuable.ncont, contribuable.nom;


-- -MIN
-- Donner le numéro, le nom le libellé et le montant des contribuables ayant payé
-- l’amande minimale
SELECT contribuable.ncont, contribuable.nom, amende.libelle, MIN(amende.montant)
FROM contribuable
INNER JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
INNER JOIN amende ON payer_amende.namende = amende.namende
GROUP BY contribuable.ncont, contribuable.nom, amende.libelle;


-- -MAX
-- Donner le numéro, le nom le libellé et le montant des contribuables ayant payé la
-- taxe maximale
SELECT contribuable.ncont, nom, declaration.libelle, MAX(taxes.montant)
FROM contribuable
INNER JOIN payer_taxe ON contribuable.ncont = payer_taxe.ncont
INNER JOIN declaration ON contribuable.ncont = declaration.ncont
INNER JOIN taxes ON payer_taxe.ntaxe = taxes.ntaxe
GROUP BY contribuable.ncont, contribuable.nom, declaration.libelle;


-- o Commande
-- - ORDER BY
-- Donner le numéro, le nom le libellé et le montant des 5(cinq) premiers
-- contribuables ayant payé la taxe maximale
SELECT contribuable.ncont, nom, declaration.libelle, MAX(taxes.montant)
FROM contribuable
INNER JOIN payer_taxe ON contribuable.ncont = payer_taxe.ncont
INNER JOIN declaration ON contribuable.ncont = declaration.ncont
INNER JOIN taxes ON payer_taxe.ntaxe = taxes.ntaxe
GROUP BY contribuable.ncont, contribuable.nom, declaration.libelle, payer_taxe.date
ORDER BY payer_taxe.date ASC
LIMIT 5;


-- -GROUP BY
-- Donner le libelle de la déclaration, le montant de la taxe et le nom du
-- contribuable des taxes payées le 2020-06-05
SELECT declaration.libelle, taxes.montant, contribuable.nom
FROM declaration
INNER JOIN contribuable ON declaration.ncont = contribuable.ncont
INNER JOIN payer_taxe ON contribuable.ncont = payer_taxe.ncont
INNER JOIN taxes ON payer_taxe.ntaxe = taxes.ntaxe
WHERE payer_taxe.date = '2020-06-05'
GROUP BY declaration.libelle, taxes.montant, contribuable.nom;


-- -HAVING
-- Donner le numéro et le nom des contribuables qui ont individuellement payé au
-- total plus de 500.000F d’amende pour des déclarations de spectacles.
SELECT contribuable.ncont, contribuable.nom, SUM(amende.montant) AS total_amendes
FROM contribuable 
INNER JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
INNER JOIN amende ON payer_amende.namende = amende.namende
INNER JOIN declaration ON contribuable.ncont = declaration.ncont
WHERE declaration.libelle = 'Spectacle'
GROUP BY contribuable.ncont, contribuable.nom
HAVING total_amendes > 500000;
-- HAVING serre à filtrer


-- -UNION
-- Donner séparément les montants totaux des taxes de spectacles ou de publicités
-- (une seule instruction SQL).
SELECT taxes.type, SUM(taxes.montant) AS total_taxe
FROM taxes
WHERE type = 'spectacle'
UNION
SELECT taxes.type, SUM(taxes.montant) AS total_taxe
FROM taxes
WHERE type = 'publicité';


-- o Autres Fonction
-- - ROUND
-- Donner le numéro et le nom des contribuables qui ont individuellement payé au
-- total plus de 500.000F d’amende pour des déclarations de spectacles.
SELECT contribuable.ncont, contribuable.nom, ROUND(SUM(amende.montant), 2) AS total_amende
FROM contribuable
INNER JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
INNER JOIN amende ON payer_amende.namende = amende.namende
INNER JOIN declaration ON payer_amende.ncont = declaration.ncont
WHERE declaration.libelle = 'spectacle'
GROUP BY contribuable.ncont, contribuable.nom
HAVING total_amende > 500000;

-- WHERE filtre les déclarations de spectacles, 
-- HAVING sélectionne les contribuables dont le montant total de l'amende dépasse 500 000F. 
-- ROUND est utilisée pour arrondir le montant total de l'amende à deux décimales.

-- -DISTINCT
-- Donner le numéro et le nom des contribuables qui n’ont jamais payé d’amende
SELECT DISTINCT contribuable.ncont, contribuable.nom
FROM contribuable
LEFT JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
WHERE payer_amende.ncont is NULL;


-- -COUNT
-- Donner le numéro et le nom des contribuables qui ont individuellement payé au
-- total plus de quatre (4) amendes
SELECT contribuable.ncont, contribuable.nom
FROM contribuable
INNER JOIN payer_amende ON contribuable.ncont = payer_amende.ncont
GROUP BY contribuable.ncont, contribuable.nom;
HAVING COUNT(pa.namende) > 4;


-- -LIMIT
-- Donner le numéro et le nom du contribuable qui a payé plus de taxe
SELECT contribuable.ncont, contribuable.nom, SUM(taxes.montant) AS total_taxes
FROM contribuable 
INNER JOIN payer_taxe pt ON contribuable.ncont = payer_taxe.ncont
INNER JOIN taxes ON payer_taxe.ntaxe = taxes.ntaxe
GROUP BY contribuable.ncont, contribuable.nom
ORDER BY total_taxes DESC
LIMIT 1;


-- -LIKE %% (B%A)
-- Donner les informations des contribuables qui habitent paris
SELECT *
FROM contribuable
WHERE adr LIKE '% Paris %' AND adr LIKE '%B%A';

-- IN & NOT IN
-- Donner le numéro et le nom des contribuables qui n’ont jamais payé d’amende.
SELECT ncont, nom
FROM contribuable
WHERE ncont NOT IN (SELECT DISTINCT ncont FROM payer_amende);


On a 8 tables:
amende (namende,libelle,montant),
contribuable (ncont,nom,adr,tel),
declaration (ndec,ncont,libelle,date),
migration_version (version,axecuted_at),
payer_amende (ncont,namende,date),
payer_taxe (ncont,ntaxe,nquit,date),
quittance (nquit,ncont,date,libelle),
taxes (ntaxe,type,montant)
-LIMIT